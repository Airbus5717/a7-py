<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>A7 Pipeline Reference</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=JetBrains+Mono:wght@400;500;600&family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #edf3f6;
      --surface: #ffffff;
      --surface-2: #e6f0f4;
      --border: rgba(20, 40, 49, 0.14);
      --text: #14242c;
      --text-dim: #4f6872;
      --accent: #097d9f;
      --accent-dim: rgba(9, 125, 159, 0.15);
      --signal: #a46421;
      --signal-dim: rgba(164, 100, 33, 0.14);
      --ok: #2c694a;
      --ok-dim: rgba(44, 105, 74, 0.14);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f171b;
        --surface: #15232a;
        --surface-2: #1f3139;
        --border: rgba(218, 238, 245, 0.16);
        --text: #daeef5;
        --text-dim: #9cbac5;
        --accent: #69d2ef;
        --accent-dim: rgba(105, 210, 239, 0.2);
        --signal: #f0c086;
        --signal-dim: rgba(240, 192, 134, 0.2);
        --ok: #9dcfb3;
        --ok-dim: rgba(157, 207, 179, 0.2);
      }
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Manrope', sans-serif;
      color: var(--text);
      background: var(--bg);
      background-image:
        radial-gradient(1100px 440px at 0% -8%, var(--accent-dim), transparent 60%),
        radial-gradient(1100px 440px at 100% 0%, var(--signal-dim), transparent 60%);
      padding: 24px;
    }

    .wrap {
      max-width: 1500px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .bar,
    .hero,
    .mermaid-wrap,
    .meta {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: var(--surface);
      padding: 20px;
    }

    .bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .bar .title {
      margin: 0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-dim);
    }

    .links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .links a {
      border: 1px solid var(--border);
      border-radius: 999px;
      text-decoration: none;
      color: var(--text-dim);
      padding: 5px 10px;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      background: var(--surface-2);
    }

    .links a:hover {
      color: var(--text);
      border-color: var(--accent);
    }

    h1 {
      margin: 8px 0 10px;
      font-family: 'Fraunces', serif;
      font-size: clamp(48px, 7vw, 90px);
      line-height: 1.02;
    }

    .lead {
      margin: 0;
      color: var(--text-dim);
      max-width: 56ch;
      font-size: clamp(19px, 1.4vw, 28px);
      line-height: 1.42;
    }

    .chips {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      background: var(--surface-2);
      color: var(--text-dim);
    }

    .mermaid-wrap {
      position: relative;
      overflow: auto;
      min-height: 560px;
    }

    .mermaid {
      min-width: 1160px;
      display: flex;
      justify-content: center;
      transition: transform 0.18s ease;
      transform-origin: top center;
    }

    .zoom-controls {
      position: absolute;
      right: 12px;
      top: 12px;
      z-index: 10;
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .zoom-controls button {
      width: 36px;
      height: 36px;
      border: 0;
      border-radius: 8px;
      background: var(--surface-2);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 17px;
      cursor: pointer;
    }

    .zoom-controls button:hover {
      background: var(--accent-dim);
    }

    .mermaid-wrap.is-zoomed { cursor: grab; }
    .mermaid-wrap.is-panning { cursor: grabbing; user-select: none; }

    .mermaid .nodeLabel {
      font-family: 'Manrope', sans-serif !important;
      font-size: 19px !important;
      line-height: 1.35;
    }

    .mermaid .edgeLabel {
      font-family: 'JetBrains Mono', monospace !important;
      font-size: 13px !important;
      padding: 2px 6px !important;
    }

    .meta-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .meta-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface-2);
      padding: 12px;
    }

    .meta-item strong {
      display: block;
      margin-bottom: 4px;
      font-size: 18px;
    }

    .meta-item span {
      color: var(--text-dim);
      font-size: 15px;
      line-height: 1.45;
    }

    @media (max-width: 900px) {
      body { padding: 12px; }
      .bar,
      .hero,
      .mermaid-wrap,
      .meta { padding: 12px; }
      .mermaid-wrap { min-height: 500px; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="bar">
      <p class="title">A7 visual atlas</p>
      <nav class="links" aria-label="Visual pages">
        <a href="./a7-docs-atlas.html">Atlas</a>
        <a href="./a7-pipeline-reference.html">Pipeline</a>
        <a href="./a7-examples-reference.html">Examples</a>
        <a href="./a7-language-map.html">Language</a>
        <a href="./">Back to Visuals</a>
      </nav>
    </section>

    <section class="hero">
      <h1>Pipeline Reference</h1>
      <p class="lead">Use this page during debugging. It maps every stage from source to Zig output and shows where diagnostics originate.</p>
      <div class="chips">
        <span class="chip">Tokenizer and parser</span>
        <span class="chip">Three semantic passes</span>
        <span class="chip">Preprocessor transformations</span>
        <span class="chip">Backend generation</span>
      </div>
    </section>

    <section class="mermaid-wrap" id="diagramWrap">
      <div class="zoom-controls">
        <button type="button" data-zoom-in>+</button>
        <button type="button" data-zoom-out>-</button>
        <button type="button" data-zoom-reset>1x</button>
      </div>
      <div class="mermaid" id="diagram">
flowchart LR
  A[Source file<br/>.a7] --> B[Tokenizer]
  B --> C[Parser]
  C --> D1[Semantic pass 1<br/>Name resolution]
  D1 --> D2[Semantic pass 2<br/>Type checking]
  D2 --> D3[Semantic pass 3<br/>Validation]
  D3 --> E[AST preprocessor]
  E --> F[Zig codegen]
  F --> G[Output .zig]

  B -. tokenize errors .-> X1[Tokenizer diagnostics]
  C -. parse errors .-> X2[Parser diagnostics]
  D3 -. semantic errors .-> X3[Semantic diagnostics]
  F -. backend errors .-> X4[Codegen diagnostics]

  classDef front fill:#d6ecf3,stroke:#097d9f,color:#132229,stroke-width:2px;
  classDef middle fill:#f7ead8,stroke:#a46421,color:#33220f,stroke-width:2px;
  classDef out fill:#deefe4,stroke:#2c694a,color:#182c20,stroke-width:2px;
  classDef err fill:#f6e0e0,stroke:#9f3434,color:#4a1414,stroke-width:2px;

  class A,B,C front;
  class D1,D2,D3,E middle;
  class F,G out;
  class X1,X2,X3,X4 err;
      </div>
    </section>

    <section class="meta">
      <div class="meta-grid">
        <article class="meta-item">
          <strong>Isolation order</strong>
          <span>Run <code>--mode tokens</code>, then <code>--mode ast</code>, then <code>--mode semantic</code>.</span>
        </article>
        <article class="meta-item">
          <strong>Machine integration</strong>
          <span>Use <code>--format json</code> with stage specific exit codes for CI checks.</span>
        </article>
        <article class="meta-item">
          <strong>Documentation output</strong>
          <span>Use <code>--doc-out auto</code> in compile mode to capture stage summaries.</span>
        </article>
      </div>
    </section>
  </main>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    import elkLayouts from 'https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0/dist/mermaid-layout-elk.esm.min.mjs';

    mermaid.registerLayoutLoaders(elkLayouts);
    mermaid.initialize({
      startOnLoad: true,
      theme: 'base',
      look: 'classic',
      layout: 'elk',
      themeVariables: {
        background: 'transparent',
        primaryColor: '#d6ecf3',
        primaryBorderColor: '#097d9f',
        primaryTextColor: '#132229',
        secondaryColor: '#f7ead8',
        secondaryBorderColor: '#a46421',
        secondaryTextColor: '#33220f',
        tertiaryColor: '#deefe4',
        tertiaryBorderColor: '#2c694a',
        tertiaryTextColor: '#182c20',
        lineColor: '#5f808d',
        edgeLabelBackground: '#edf3f6',
        fontSize: '18px',
        fontFamily: 'Manrope',
      },
      flowchart: {
        curve: 'basis',
        htmlLabels: true,
      },
    });

    const wrap = document.getElementById('diagramWrap');
    const graph = document.getElementById('diagram');
    const btnIn = document.querySelector('[data-zoom-in]');
    const btnOut = document.querySelector('[data-zoom-out]');
    const btnReset = document.querySelector('[data-zoom-reset]');

    let zoom = 1;
    let isPanning = false;
    let startX = 0;
    let startY = 0;
    let scrollLeft = 0;
    let scrollTop = 0;

    const applyZoom = () => {
      graph.style.transform = `scale(${zoom})`;
      wrap.classList.toggle('is-zoomed', zoom > 1.01);
    };

    btnIn.addEventListener('click', () => {
      zoom = Math.min(zoom + 0.12, 3);
      applyZoom();
    });

    btnOut.addEventListener('click', () => {
      zoom = Math.max(zoom - 0.12, 0.65);
      applyZoom();
    });

    btnReset.addEventListener('click', () => {
      zoom = 1;
      applyZoom();
      wrap.scrollTo({ left: 0, top: 0, behavior: 'smooth' });
    });

    wrap.addEventListener('wheel', (event) => {
      if (!(event.ctrlKey || event.metaKey)) {
        return;
      }
      event.preventDefault();
      zoom += event.deltaY < 0 ? 0.08 : -0.08;
      zoom = Math.min(Math.max(zoom, 0.65), 3);
      applyZoom();
    }, { passive: false });

    wrap.addEventListener('mousedown', (event) => {
      if (zoom <= 1.01) {
        return;
      }
      isPanning = true;
      wrap.classList.add('is-panning');
      startX = event.pageX - wrap.offsetLeft;
      startY = event.pageY - wrap.offsetTop;
      scrollLeft = wrap.scrollLeft;
      scrollTop = wrap.scrollTop;
    });

    window.addEventListener('mouseup', () => {
      isPanning = false;
      wrap.classList.remove('is-panning');
    });

    wrap.addEventListener('mousemove', (event) => {
      if (!isPanning) {
        return;
      }
      event.preventDefault();
      const x = event.pageX - wrap.offsetLeft;
      const y = event.pageY - wrap.offsetTop;
      wrap.scrollLeft = scrollLeft - (x - startX);
      wrap.scrollTop = scrollTop - (y - startY);
    });
  </script>
</body>
</html>
