---
import path from 'node:path';
import { readFileSync } from 'node:fs';

type ExampleEntry = {
  file: string;
  title: string;
  summary: string;
  focus: string[];
};

type ExampleGroup = {
  id: string;
  title: string;
  description: string;
  entries: ExampleEntry[];
};

const PREVIEW_LINE_COUNT = 16;
const repoRoot = path.resolve(process.cwd(), '..');
const examplesDir = path.join(repoRoot, 'examples');

const groups: ExampleGroup[] = [
  {
    id: 'utility',
    title: 'Utility',
    description: 'Minimal inputs for smoke and parser checks.',
    entries: [
      {
        file: '000_empty.a7',
        title: 'Empty File',
        summary: 'Valid empty input for parser and pipeline smoke checks.',
        focus: ['smoke input', 'pipeline baseline'],
      },
    ],
  },
  {
    id: 'fundamentals',
    title: 'Fundamentals',
    description: 'Core syntax, declarations, literals, and operators.',
    entries: [
      { file: '001_hello.a7', title: 'Hello Output', summary: 'Smallest runnable program with std io import.', focus: ['imports', 'entry function'] },
      { file: '002_var.a7', title: 'Variables', summary: 'Local values and update semantics.', focus: ['local bindings', 'value updates'] },
      { file: '003_comments.a7', title: 'Comments', summary: 'Line and block comment forms.', focus: ['tokenizer behavior', 'source readability'] },
      { file: '004_func.a7', title: 'Functions', summary: 'Function declaration and invocation.', focus: ['parameters', 'return values'] },
      { file: '015_types.a7', title: 'Type Annotations', summary: 'Explicit type annotations and assignments.', focus: ['typed bindings', 'type clarity'] },
      { file: '019_literals.a7', title: 'Literal Forms', summary: 'Numeric, string, and boolean literal coverage.', focus: ['literal parsing', 'value forms'] },
      { file: '020_operators.a7', title: 'Operators', summary: 'Arithmetic and logical operators in expressions.', focus: ['operator precedence', 'expression checks'] },
    ],
  },
  {
    id: 'control',
    title: 'Control Flow',
    description: 'Branching, loops, and deferred execution.',
    entries: [
      { file: '005_for_loop.a7', title: 'For Loops', summary: 'Counted loops and range style loops.', focus: ['loop forms', 'break and continue'] },
      { file: '006_if.a7', title: 'If Else', summary: 'Conditional blocks and if expressions.', focus: ['branching', 'boolean logic'] },
      { file: '007_while.a7', title: 'While Loops', summary: 'Condition driven loop behavior.', focus: ['loop condition', 'state updates'] },
      { file: '008_switch.a7', title: 'Switch Match Style', summary: 'Multi branch control logic.', focus: ['branch dispatch', 'case evaluation'] },
      { file: '021_control_flow.a7', title: 'Combined Control Flow', summary: 'Mixed control statements in one file.', focus: ['flow combinations', 'validator checks'] },
      { file: '024_defer.a7', title: 'Defer Order', summary: 'Deferred cleanup and execution order.', focus: ['defer stack order', 'scope cleanup'] },
    ],
  },
  {
    id: 'data',
    title: 'Data And Memory',
    description: 'Structs, enums, arrays, pointers, and larger data layouts.',
    entries: [
      { file: '009_struct.a7', title: 'Struct Values', summary: 'Struct declarations and field access.', focus: ['struct literals', 'field reads'] },
      { file: '010_enum.a7', title: 'Enum Variants', summary: 'Enum declaration and variant selection.', focus: ['enum symbols', 'variant usage'] },
      { file: '011_memory.a7', title: 'Memory Basics', summary: 'Stack and heap allocation patterns.', focus: ['new and delete', 'allocation path'] },
      { file: '012_arrays.a7', title: 'Arrays', summary: 'Fixed arrays with indexed iteration.', focus: ['array literals', 'index operations'] },
      { file: '013_pointers.a7', title: 'Pointer Helpers', summary: 'Reference semantics with .adr and .val.', focus: ['address and deref', 'pointer mutation'] },
      { file: '016_unions.a7', title: 'Unions', summary: 'Union declarations and value handling.', focus: ['union forms', 'typed variants'] },
      { file: '023_inline_structs.a7', title: 'Inline Structs', summary: 'Inline struct construction patterns.', focus: ['inline types', 'literal syntax'] },
      { file: '025_linked_list.a7', title: 'Linked List', summary: 'Node pointers and linked traversal.', focus: ['recursive structure', 'reference links'] },
      { file: '026_binary_tree.a7', title: 'Binary Tree', summary: 'Tree style node hierarchy.', focus: ['nested nodes', 'tree traversal'] },
      { file: '035_matrix.a7', title: 'Matrix Values', summary: 'Flat array matrix style operations.', focus: ['index math', 'numeric loops'] },
    ],
  },
  {
    id: 'abstractions',
    title: 'Functions And Abstractions',
    description: 'Generics, methods, function values, and callback style dispatch.',
    entries: [
      { file: '014_generics.a7', title: 'Generics Surface', summary: 'Generic language surface in runnable form.', focus: ['generic syntax', 'semantic hooks'] },
      { file: '017_methods.a7', title: 'Method Style', summary: 'Method oriented call patterns.', focus: ['method calls', 'receiver style'] },
      { file: '022_function_pointers.a7', title: 'Function Values', summary: 'Function references as values.', focus: ['callable types', 'indirect calls'] },
      { file: '027_callbacks.a7', title: 'Callback Dispatch', summary: 'Match based callback routing.', focus: ['callback pattern', 'event handling'] },
    ],
  },
  {
    id: 'programs',
    title: 'Modules And Programs',
    description: 'Imports and multi step program examples.',
    entries: [
      { file: '018_modules.a7', title: 'Module Imports', summary: 'Import syntax and std usage.', focus: ['module loading', 'stdlib usage'] },
      { file: '028_state_machine.a7', title: 'State Machine', summary: 'State transition logic in program flow.', focus: ['state transitions', 'control checks'] },
      { file: '029_sorting.a7', title: 'Sorting', summary: 'Array sorting with nested loops.', focus: ['algorithm loops', 'swap logic'] },
      { file: '030_calculator.a7', title: 'Calculator', summary: 'Expression evaluation in a larger sample.', focus: ['program structure', 'expression parsing'] },
      { file: '031_number_guessing.a7', title: 'Number Guessing', summary: 'Interactive style loop logic.', focus: ['loop control', 'program state'] },
      { file: '032_prime_numbers.a7', title: 'Prime Numbers', summary: 'Prime generation loops and checks.', focus: ['numeric loops', 'condition logic'] },
      { file: '033_fibonacci.a7', title: 'Fibonacci', summary: 'Sequence generation patterns.', focus: ['recurrence logic', 'loop updates'] },
      { file: '034_string_utils.a7', title: 'String Utilities', summary: 'String handling helpers and output formatting.', focus: ['string operations', 'helper functions'] },
    ],
  },
];

type RenderedEntry = ExampleEntry & {
  path: string;
  source: string;
  preview: string;
  lineCount: number;
  hasMore: boolean;
};

type RenderedGroup = Omit<ExampleGroup, 'entries'> & { entries: RenderedEntry[] };

const readExampleSource = (file: string): string => {
  const fullPath = path.join(examplesDir, file);
  try {
    return readFileSync(fullPath, 'utf-8').trimEnd();
  } catch {
    return `// Missing file: ${file}`;
  }
};

const renderGroups: RenderedGroup[] = groups.map((group) => {
  const entries = group.entries.map((entry) => {
    const source = readExampleSource(entry.file);
    const lines = source.split(/\r?\n/);
    const preview = lines.slice(0, PREVIEW_LINE_COUNT).join('\n');

    return {
      ...entry,
      path: `examples/${entry.file}`,
      source,
      preview,
      lineCount: lines.length,
      hasMore: lines.length > PREVIEW_LINE_COUNT,
    };
  });

  return {
    ...group,
    entries,
  };
});

const totalExamples = renderGroups.reduce((sum, group) => sum + group.entries.length, 0);
---

<div class="doc-callout">
  <p><strong>Catalog summary.</strong> This page includes all example files grouped by topic. Each example has context, a short preview, and expandable full source.</p>
</div>

<div class="kpi-grid">
  <section class="kpi">
    <p class="value">{totalExamples}</p>
    <p class="label">Example files indexed</p>
  </section>
  <section class="kpi">
    <p class="value">{renderGroups.length}</p>
    <p class="label">Topic groups</p>
  </section>
  <section class="kpi">
    <p class="value">{PREVIEW_LINE_COUNT}</p>
    <p class="label">Preview lines per example</p>
  </section>
</div>

<nav class="topic-jump" aria-label="Topic jump links">
  {renderGroups.map((group) => (
    <a class="topic-jump__link" href={`#${group.id}`}>
      <strong>{group.title}</strong>
      <span>{group.entries.length} files</span>
    </a>
  ))}
</nav>

{renderGroups.map((group) => (
  <section class="topic-section" id={group.id}>
    <header class="topic-section__header">
      <h2>{group.title}</h2>
      <p>{group.description}</p>
    </header>

    <div class="example-grid">
      {group.entries.map((entry) => (
        <article class="example-card">
          <div class="example-card__head">
            <h3>{entry.title}</h3>
            <p>{entry.summary}</p>
          </div>

          <p class="example-meta">
            <code>{entry.path}</code>
            <span>{entry.lineCount} lines</span>
          </p>

          <ul class="example-focus">
            {entry.focus.map((item) => (
              <li>{item}</li>
            ))}
          </ul>

          <details class="example-source">
            <summary>Preview</summary>
            <pre><code class="language-odin">{entry.preview}{entry.hasMore ? '\n...' : ''}</code></pre>
          </details>

          <details class="example-source">
            <summary>Full source</summary>
            <pre><code class="language-odin">{entry.source}</code></pre>
          </details>
        </article>
      ))}
    </div>
  </section>
))}
